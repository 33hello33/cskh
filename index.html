<!-- Index.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="js/app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω chƒÉm s√≥c kh√°ch h√†ng</title>
    <?!= include('CSS'); ?>
</head>
<body class="hide-order-columns">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <div id="user-info" class="user-info-header" style="display: none;">
                    <span id="current-user-name"></span>
                    <button class="btn btn-sm btn-secondary" onclick="showChangePasswordModal()" style="background: #6B7280;">
                        <i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="performLogout()">
                        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                    </button>
                </div>
                Qu·∫£n l√Ω chƒÉm s√≥c kh√°ch h√†ng
                <span style="font-size: 14px; font-weight: 400; color: #999; margin-left: 8px;">(Version: 6.0)</span>
            </h1>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="customers">
                <i class="fas fa-users"></i> Kh√°ch h√†ng
            </div>
            <div class="nav-tab" data-tab="reports">
                <i class="fas fa-chart-bar"></i> B√°o c√°o
            </div>
            <div class="nav-tab manager-only" data-tab="settings">
                <i class="fas fa-cog"></i> C√†i ƒë·∫∑t
            </div>
            <div class="nav-tab" data-tab="reminders" style="position: relative;">
                <i class="fas fa-tasks"></i> Nh·∫Øc vi·ªác
                <span id="reminder-tab-badge" class="tab-notification-badge" style="display: none;">0</span>
            </div>
            <div class="nav-tab" data-tab="history">
                <i class="fas fa-history"></i> L·ªãch s·ª≠
            </div>
        </div>

        <!-- Main Content -->
        <div class="glass-card">
            <!-- Customers Section -->
            <div id="customers" class="content-section active">
                
                <div id="status-tabs-container" class="status-tabs-wrapper">
                    </div>

                <div class="filter-controls">
                    
                    <button class="toggle-columns-btn" onclick="toggleOrderColumns()" id="toggle-order-btn">
                        <i class="fas fa-eye-slash"></i> ·∫®n c·ªôt
                    </button>
                    
                    <input type="text" 
                          id="search-input" 
                          class="form-control search-input" 
                          placeholder="T√¨m ki·∫øm t·ª´ kho√°...">
                    
                    <select id="staff-filter" class="form-control filter-select">
                        <option value="">T·∫•t c·∫£ nh√¢n vi√™n</option>
                    </select>
                    
                    <div style="display: flex; align-items: center;">
                        <select id="date-filter" class="form-control filter-select">
                            <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
                            <option value="today">H√¥m nay</option>
                            <option value="thisMonth" selected>Th√°ng n√†y</option>
                            <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                            <option value="custom">üìÖ T·ª± ch·ªçn...</option> 
                        </select>
                        
                        <input type="text" id="custom-date-picker" class="form-control filter-select" 
                              style="display: none; min-width: 180px; background: #fff;" 
                              placeholder="Ch·ªçn kho·∫£ng ng√†y...">
                    </div>
                    
                    <button class="btn btn-secondary" onclick="resetCustomerFilters()" style="margin-left: 5px; height: 36px;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="care-needed-filter">
                        <label class="checkbox-label">
                            <input type="checkbox" 
                                  id="care-needed-checkbox" 
                                  class="care-needed-checkbox">
                            <span>C·∫ßn chƒÉm 7 ng√†y t·ªõi</span>
                        </label>
                    </div>
                    
                    <button class="btn btn-success" onclick="showAddCustomerModal()">
                        <i class="fas fa-plus"></i> Th√™m
                    </button>
                </div>

                <!-- Table View - GI·ªÆ NGUY√äN -->
                <div id="table-view" class="table-container" style="display: block;">
                  <table class="data-table">
                      <thead>
                        <tr>
                            <th onclick="sortTable('id')" style="cursor: pointer; width: 50px;">
                                ID <i class="fas fa-sort" id="sort-id"></i>
                            </th>
                            
                            <th onclick="sortTable('createdDate')" style="cursor: pointer;">
                                Ng√†y t·∫°o <i class="fas fa-sort" id="sort-createdDate"></i>
                            </th>
                            <th onclick="sortTable('name')" style="cursor: pointer;">
                                T√™n <i class="fas fa-sort" id="sort-name"></i>
                            </th>
                            <th onclick="sortTable('phone')" style="cursor: pointer;">
                                ƒêi·ªán tho·∫°i <i class="fas fa-sort" id="sort-phone"></i>
                            </th>
                            <th onclick="sortTable('source')" style="cursor: pointer;">
                                Ngu·ªìn <i class="fas fa-sort" id="sort-source"></i>
                            </th>
                            <th onclick="sortTable('status')" style="cursor: pointer;">
                                Tr·∫°ng th√°i <i class="fas fa-sort" id="sort-status"></i>
                            </th>
                            <th onclick="sortTable('assignedStaff')" style="cursor: pointer;">
                                Ph·ª• tr√°ch <i class="fas fa-sort" id="sort-assignedStaff"></i>
                            </th>
                            <th onclick="sortTable('notes')" style="cursor: pointer;">
                                Ghi ch√∫ <i class="fas fa-sort" id="sort-notes"></i>
                            </th>
                            <th onclick="sortTable('closedDate')" style="cursor: pointer;" class="order-column">
                                Ng√†y ch·ªët g·∫ßn nh·∫•t <i class="fas fa-sort" id="sort-closedDate"></i>
                            </th>
                            <th onclick="sortTable('orderCode')" style="cursor: pointer;" class="order-column">
                                M√£ ƒë∆°n g·∫ßn nh·∫•t <i class="fas fa-sort" id="sort-orderCode"></i>
                            </th>
                            <th onclick="sortTable('orderValue')" style="cursor: pointer;">
                                Doanh thu <i class="fas fa-sort" id="sort-orderValue"></i>
                            </th>
                            <th onclick="sortTable('lastContact')" style="cursor: pointer;">
                                Li√™n h·ªá g·∫ßn nh·∫•t <i class="fas fa-sort" id="sort-lastContact"></i>
                            </th>
                            <th onclick="sortTable('nextContact')" style="cursor: pointer;">
                                Ng√†y li√™n h·ªá ti·∫øp <i class="fas fa-sort" id="sort-nextContact"></i>
                            </th>
                            <th>Thao t√°c</th>
                        </tr>
                      </thead>
                      <tbody id="customers-list">
                          <tr>
                            <tr>
                                <td colspan="12" class="loading-cell">
                                    <div class="loading">ƒêang t·∫£i...</div>
                                </td>
                            </tr>
                          </tr>
                      </tbody>
                  </table>
                </div>

                <!-- Pagination - GI·ªÆ NGUY√äN -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span>Hi·ªÉn th·ªã <span id="showing-from">1</span>-<span id="showing-to">10</span> trong t·ªïng <span id="total-customers">0</span> kh√°ch h√†ng</span>
                    </div>
                    
                    <div class="pagination-controls">
                        <div class="items-per-page">
                            <label for="items-per-page">S·ªë d√≤ng/trang:</label>
                            <select id="items-per-page" class="form-control">
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        
                        <div class="pagination-buttons">
                            <button class="btn btn-secondary btn-sm" id="prev-page" onclick="changePage(-1)">
                                <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
                            </button>
                            <span class="page-info">Trang <span id="current-page">1</span> / <span id="total-pages">1</span></span>
                            <button class="btn btn-secondary btn-sm" id="next-page" onclick="changePage(1)">
                                Sau <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="content-section">
                <div class="reports-filter-controls">
                    <div class="date-range-filter">
                        <label for="report-from-date">T·ª´ ng√†y:</label>
                        <input type="date" id="report-from-date" class="form-control">
                    </div>
                    <div class="date-range-filter">
                        <label for="report-to-date">ƒê·∫øn ng√†y:</label>
                        <input type="date" id="report-to-date" class="form-control">
                    </div>
                    <div class="date-range-filter">
                        <label for="report-staff-filter">Nh√¢n vi√™n:</label>
                        <select id="report-staff-filter" class="form-control" onchange="renderReports()">
                            <option value="">T·∫•t c·∫£ nh√¢n vi√™n</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="resetReportDateFilter()">
                        <i class="fas fa-refresh"></i> Reset
                    </button>
                </div>
                <div class="reports-grid">
                    <!-- Overview Cards -->
                    <div class="overview-cards">
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="card-content">
                                <h3 id="total-customers-count">0</h3>
                                <p>T·ªïng kh√°ch h√†ng</p>
                            </div>
                        </div>
                        
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="card-content">
                                <h3 id="total-care-count">0</h3>
                                <p>T·ªïng doanh thu</p>
                            </div>
                        </div>
                        
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="card-content">
                                <h3 id="today-customers-count">0</h3>
                                <p>Kh√°ch h√†ng h√¥m nay</p>
                            </div>
                        </div>
                        
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="card-content">
                                <h3 id="top-staff-name">-</h3>
                                <p>Nh√¢n vi√™n t√≠ch c·ª±c nh·∫•t</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts - c·∫≠p nh·∫≠t th√†nh 6 bi·ªÉu ƒë·ªì -->
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-pie"></i> Ph√¢n b·ªë theo tr·∫°ng th√°i</h3>
                            <canvas id="statusChart"></canvas>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-bar"></i> Kh√°ch h√†ng theo nh√¢n vi√™n</h3>
                            <canvas id="staffChart"></canvas>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-line"></i> Xu h∆∞·ªõng theo ng√†y</h3>
                            <canvas id="trendChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3><i class="fas fa-share-alt"></i> Kh√°ch h√†ng theo ngu·ªìn</h3>
                            <canvas id="sourceChart"></canvas>
                        </div>               

                        <div class="chart-card">
                            <h3><i class="fas fa-trophy"></i> Top sale ch·ªët</h3>
                            <canvas id="staffPerformanceChart"></canvas>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-calendar-alt"></i> Theo d√µi theo th√°ng</h3>
                            <canvas id="monthlyChart"></canvas>
                        </div>

                        <div class="chart-card">
                            <h3><i class="fas fa-trophy"></i> Top doanh thu theo kh√°ch h√†ng</h3>
                            <div id="topCustomersList" class="top-list"></div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-money-bill-wave"></i> Doanh thu theo ngu·ªìn kh√°ch</h3>
                            <canvas id="sourceRevenueChart"></canvas>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-user-tie"></i> Doanh thu theo nh√¢n vi√™n</h3>
                            <div id="staffRevenueList" class="top-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reminders" class="content-section">
                <div class="filter-controls" style="margin-bottom: 15px; flex-wrap: wrap;">
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">H·∫°n:</label>
                        <input type="date" id="remind-filter-date" class="form-control" style="width: auto;" onchange="filterRemindersUI()">
                    </div>

                    <div style="flex: 1; min-width: 200px; display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="remind-search-input" class="form-control" style="flex: 1;" placeholder="T√¨m vi·ªác, ng∆∞·ªùi giao..." onkeyup="filterRemindersUI()">
                        
                        <button class="btn btn-success" onclick="showAddReminderModal()" style="white-space: nowrap;">
                            <i class="fas fa-plus"></i> Th√™m
                        </button>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
    
                    <div class="remind-tabs-container">
                        <button class="remind-tab-btn active" onclick="switchRemindFilter('pending')" id="tab-pending">
                            C·∫ßn l√†m <span id="count-pending" class="status-count-badge">0</span>
                        </button>
                        <button class="remind-tab-btn" onclick="switchRemindFilter('done')" id="tab-done">
                            ƒê√£ xong <span id="count-done" class="status-count-badge">0</span>
                        </button>
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span id="remind-showing-info" style="font-size: 13px; color: #666; margin-right: 5px;">0-0 / 0</span>
                        <button class="btn btn-sm btn-secondary" onclick="changeRemindPage(-1)"><i class="fas fa-chevron-left"></i></button>
                        <span id="remind-page-info" style="font-size: 13px; font-weight: 600; min-width: 30px; text-align: center;">1/1</span>
                        <button class="btn btn-sm btn-secondary" onclick="changeRemindPage(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">H·∫°n</th>
                                    <th style="width: 80px;">M·ª©c ƒë·ªô</th>
                                    <th>N·ªôi dung c√¥ng vi·ªác</th>
                                    <th style="width: 150px;">Ng∆∞·ªùi g·ª≠i</th>
                                    <th style="width: 150px;">Ng∆∞·ªùi nh·∫≠n</th>
                                    <th style="width: 100px;">Tr·∫°ng th√°i</th>
                                    <th style="width: 100px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="reminder-list-container">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="history" class="content-section">
                <div class="filter-controls" style="margin-bottom: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">Xem ng√†y:</label>
                        <input type="date" id="history-date-filter" class="form-control" style="width: auto;" onchange="loadHistoryLogs()">
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="history-action-filter" class="form-control filter-select" onchange="filterHistoryTable()">
                            <option value="">T·∫•t c·∫£ h√†nh ƒë·ªông</option>
                            <option value="Th√™m">Th√™m</option>
                            <option value="S·ª≠a">S·ª≠a</option>
                            <option value="X√≥a">X√≥a</option>
                        </select>
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="history-category-filter" class="form-control filter-select" onchange="filterHistoryTable()">
                            <option value="">T·∫•t c·∫£ ph√¢n lo·∫°i</option>
                            <option value="Kh√°ch h√†ng">Kh√°ch h√†ng</option>
                            <option value="ƒê∆°n h√†ng">ƒê∆°n h√†ng</option>
                            <option value="L·ªãch s·ª≠ chƒÉm s√≥c">L·ªãch s·ª≠ chƒÉm s√≥c</option>
                        </select>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px; display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="history-search-input" class="form-control" style="flex: 1;" placeholder="T√¨m ki·∫øm trong l·ªãch s·ª≠..." onkeyup="filterHistoryTable()">
                        
                        <div id="history-pagination-controls" style="display: flex; align-items: center; gap: 5px; background: white; padding: 4px 12px; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <span id="hist-showing-info" style="font-size: 13px; color: #666; margin-right: 5px; white-space: nowrap;">
                                0-0 trong t·ªïng 0
                            </span>

                            <button class="btn btn-sm btn-secondary" id="hist-prev" onclick="changeHistoryPage(-1)" disabled style="padding: 0 8px; height: 26px; line-height: 1;">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="hist-page-info" style="font-size: 13px; font-weight: 600; min-width: 30px; text-align: center; user-select: none;">
                                1/1
                            </span>
                            <button class="btn btn-sm btn-secondary" id="hist-next" onclick="changeHistoryPage(1)" disabled style="padding: 0 8px; height: 26px; line-height: 1;">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Gi·ªù</th>
                                    <th style="width: 150px;">Ng∆∞·ªùi l√†m</th>
                                    <th style="width: 100px;">H√†nh ƒë·ªông</th>
                                    <th style="width: 120px;">Ph√¢n lo·∫°i</th>
                                    <th style="width: 180px;">Kh√°ch h√†ng</th> 
                                    <th>Chi ti·∫øt thay ƒë·ªïi</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="content-section">
                <div class="settings-grid">
                    <!-- Staff Management -->
                    <div class="settings-card">
                        <h3><i class="fas fa-users"></i> Qu·∫£n l√Ω nh√¢n vi√™n</h3>
                        <div id="staff-list" class="settings-list">
                            <div class="loading">ƒêang t·∫£i...</div>
                        </div>
                        <button class="btn btn-success" onclick="addStaff()">
                            <i class="fas fa-plus"></i> Th√™m nh√¢n vi√™n
                        </button>
                    </div>

                    <!-- Status Management -->
                    <div class="settings-card">
                        <h3><i class="fas fa-chart-pie"></i> Qu·∫£n l√Ω tr·∫°ng th√°i</h3>
                        <div id="status-list" class="settings-list">
                            <div class="loading">ƒêang t·∫£i...</div>
                        </div>
                        <button class="btn btn-success" onclick="addStatus()">
                            <i class="fas fa-plus"></i> Th√™m tr·∫°ng th√°i
                        </button>
                    </div>

                    <!-- TH√äM M·ªöI: Source Management -->
                    <div class="settings-card">
                        <h3><i class="fas fa-share-alt"></i> Qu·∫£n l√Ω ngu·ªìn kh√°ch</h3>
                        <div id="source-list" class="settings-list">
                            <div class="loading">ƒêang t·∫£i...</div>
                        </div>
                        <button class="btn btn-success" onclick="addSource()">
                            <i class="fas fa-plus"></i> Th√™m ngu·ªìn kh√°ch
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-lock"></i> ƒêƒÉng nh·∫≠p h·ªá th·ªëng
                </h2>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="username">T√äN ƒêƒÇNG NH·∫¨P <span class="required-star">*</span></label>
                    <input type="text" 
                          id="username" 
                          name="username" 
                          class="form-control" 
                          placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" 
                          required 
                          autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="password">M·∫¨T KH·∫®U <span class="required-star">*</span></label>
                    <input type="password" 
                          id="password" 
                          name="password" 
                          class="form-control" 
                          placeholder="Nh·∫≠p m·∫≠t kh·∫©u" 
                          required 
                          autocomplete="current-password">
                </div>

                <div class="d-flex gap-3 justify-content-center mt-4">
                    <button type="button" class="btn btn-success" onclick="performLogin()">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="customer-modal-title" class="modal-title">Th√™m kh√°ch h√†ng m·ªõi</h2>
                <button class="close">&times;</button>
            </div>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                
                <!-- D√≤ng 1: Ng√†y t·∫°o - T√™n kh√°ch h√†ng - S·ªë ƒëi·ªán tho·∫°i -->
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="customer-created-date">Ng√†y t·∫°o <span class="required-star">*</span></label>
                        <input type="date" 
                              id="customer-created-date" 
                              name="createdDate" 
                              class="form-control" 
                              required>
                    </div>
                    <div style="flex: 2;">
                        <label for="customer-name">T√™n kh√°ch h√†ng <span class="required-star">*</span></label>
                        <input type="text" 
                              id="customer-name" 
                              name="name" 
                              class="form-control" 
                              placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" 
                              required>
                    </div>
                    <div style="flex: 1.5;">
                        <label for="customer-phone">S·ªë ƒëi·ªán tho·∫°i <span class="required-star">*</span></label>
                        <input type="tel" 
                              id="customer-phone" 
                              name="phone" 
                              class="form-control" 
                              placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                              required>
                    </div>
                </div>

                <!-- D√≤ng 2: Ghi ch√∫ -->
                <div class="form-group">
                    <label for="customer-notes">Ghi ch√∫</label>
                    <textarea id="customer-notes" 
                              name="notes" 
                              class="form-control" 
                              rows="2" 
                              placeholder="Nh·∫≠p ghi ch√∫"></textarea>
                </div>

                <!-- D√≤ng 3: ƒê·ªãa ch·ªâ -->
                <div class="form-group">
                    <label for="customer-address">ƒê·ªãa ch·ªâ</label>
                    <textarea id="customer-address" 
                              name="address" 
                              class="form-control" 
                              rows="1" 
                              placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ"></textarea>
                </div>

                <!-- D√≤ng 4: Tr·∫°ng th√°i - Ng∆∞·ªùi ph·ª• tr√°ch - Ngu·ªìn kh√°ch -->
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="customer-status">Tr·∫°ng th√°i</label>
                        <select id="customer-status" 
                                name="status" 
                                class="form-control"
                                onchange="toggleClosedFields()">
                            <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="customer-assigned-staff">Ng∆∞·ªùi ph·ª• tr√°ch</label>
                        <select id="customer-assigned-staff" 
                                name="assignedStaff" 
                                class="form-control">
                            <option value="">Ch·ªçn nh√¢n vi√™n</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="customer-source">Ngu·ªìn kh√°ch</label>
                        <select id="customer-source" 
                                name="source" 
                                class="form-control">
                            <option value="">Ch·ªçn ngu·ªìn kh√°ch</option>
                        </select>
                    </div>
                </div>

                <!-- TH√äM M·ªöI: C√°c field ch·ªâ hi·ªán khi status = "ƒê√£ ch·ªët" -->
                <div id="closed-fields" style="display: none;">
                    <div class="form-group" style="display: flex; gap: 15px;">
                        <div style="flex: 1;">
                            <label for="customer-closed-date">Ng√†y ch·ªët <span class="required-star">*</span></label>
                            <input type="date" 
                                  id="customer-closed-date" 
                                  name="closedDate" 
                                  class="form-control"
                                  required>
                        </div>
                        <div style="flex: 1;">
                            <label for="customer-order-code">M√£ ƒë∆°n h√†ng</label>
                            <input type="text" 
                                  id="customer-order-code" 
                                  name="orderCode" 
                                  class="form-control" 
                                  placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
                        </div>
                        <div style="flex: 1;">
                            <label for="customer-order-value">Gi√° tr·ªã ƒë∆°n h√†ng <span class="required-star">*</span></label>
                            <input type="text" 
                                  id="customer-order-value" 
                                  name="orderValue" 
                                  class="form-control" 
                                  placeholder="Nh·∫≠p gi√° tr·ªã ƒë∆°n h√†ng"
                                  oninput="formatOrderValue(this)"
                                  required>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveCustomer()">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- TH√äM M·ªöI: Source Modal -->
    <div id="source-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="source-modal-title" class="modal-title">Th√™m ngu·ªìn kh√°ch m·ªõi</h2>
                <button class="close">&times;</button>
            </div>
            <form id="source-form">
                <input type="hidden" id="source-id">
                
                <div class="form-group">
                    <label for="source-name">T√™n ngu·ªìn kh√°ch *</label>
                    <input type="text" 
                          id="source-name" 
                          name="name" 
                          class="form-control" 
                          placeholder="Nh·∫≠p t√™n ngu·ªìn kh√°ch" 
                          required>
                </div>

                <div class="form-group">
                    <label for="source-description">M√¥ t·∫£</label>
                    <textarea id="source-description" 
                              name="description" 
                              class="form-control" 
                              rows="3" 
                              placeholder="Nh·∫≠p m√¥ t·∫£ ngu·ªìn kh√°ch"></textarea>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveSource()">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customer-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span id="detail-customer-name"></span>
                </h2>
                <button class="close">&times;</button>
            </div>
            
            <div id="detail-customer-info" class="mb-4">
                <!-- Customer info will be populated here -->
            </div>

            <h3 class="text-white mb-3"><i class="fas fa-history"></i> L·ªãch s·ª≠ chƒÉm s√≥c</h3>
            <div id="care-history-list" class="care-history mb-4">
                <div class="loading">ƒêang t·∫£i...</div>
            </div>

            <div class="text-center">
                <button class="btn btn-success" onclick="addCareHistory(currentCustomer?.id)">
                    <i class="fas fa-plus"></i> Th√™m l·ªãch s·ª≠ chƒÉm s√≥c
                </button>
            </div>
        </div>
    </div>

    <!-- Care History Modal -->
    <div id="care-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    Th√™m l·ªãch s·ª≠ chƒÉm s√≥c - <span id="care-customer-name"></span>
                </h2>
                <button class="close">&times;</button>
            </div>
            
            <form id="care-form">
               <input type="hidden" id="care-entry-id" name="entryId" value="">
                <div class="form-group">
                    <label for="care-contact-date">Ng√†y li√™n h·ªá<span class="required-star">*</span></label>
                    <input type="date" 
                           id="care-contact-date" 
                           name="contactDate" 
                           class="form-control" 
                           required>
                </div>

                <div class="form-group">
                    <label for="care-content">N·ªôi dung chƒÉm s√≥c <span class="required-star">*</span></label>
                    <textarea id="care-content" 
                              name="content" 
                              class="form-control" 
                              rows="4" 
                              placeholder="M√¥ t·∫£ chi ti·∫øt cu·ªôc g·ªçi/li√™n h·ªá..."
                              required></textarea>
                </div>

                <div class="form-group">
                    <label for="care-next-contact-date">Ng√†y li√™n h·ªá ti·∫øp theo</label>
                    <input type="date" 
                           id="care-next-contact-date" 
                           name="nextContactDate" 
                           class="form-control">
                </div>

                <div class="form-group">
                    <label for="care-staff">Nh√¢n vi√™n th·ª±c hi·ªán *</label>
                    <select id="care-staff" 
                            name="staff" 
                            class="form-control" 
                            required>
                        <option value="">Ch·ªçn nh√¢n vi√™n</option>
                    </select>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="cancelCareModal()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveCareHistory()">
                        <i class="fas fa-save"></i> L∆∞u l·ªãch s·ª≠
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
                <button class="close">&times;</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px;">
                <!-- Staff List -->
                <div>
                    <h3 class="mb-3"><i class="fas fa-users"></i> Danh s√°ch nh√¢n vi√™n</h3>
                    <div id="staff-list" class="mb-3">
                        <div class="loading">ƒêang t·∫£i...</div>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="addStaff()">
                        <i class="fas fa-plus"></i> Th√™m nh√¢n vi√™n
                    </button>
                </div>

                <!-- Status List -->
                <div>
                    <h3 class="mb-3"><i class="fas fa-chart-pie"></i> Danh s√°ch tr·∫°ng th√°i</h3>
                    <div id="status-list" class="mb-3">
                        <div class="loading">ƒêang t·∫£i...</div>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="addStatus()">
                        <i class="fas fa-plus"></i> Th√™m tr·∫°ng th√°i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="staff-modal-title" class="modal-title">Th√™m nh√¢n vi√™n m·ªõi</h2>
                <button class="close">&times;</button>
            </div>
            <form id="staff-form">
                <input type="hidden" id="staff-id">
                
                <!-- D√≤ng 1: T√™n nh√¢n vi√™n | Ch·ª©c v·ª• -->
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="staff-name">T√™n nh√¢n vi√™n *</label>
                        <input type="text" 
                              id="staff-name" 
                              name="name" 
                              class="form-control" 
                              placeholder="Nh·∫≠p t√™n nh√¢n vi√™n" 
                              required>
                    </div>
                    <div style="flex: 1;">
                        <label for="staff-position">Ch·ª©c v·ª• *</label>
                        <select id="staff-position"
                                name="position" 
                                class="form-control" 
                                required>
                            <option value="Nh√¢n vi√™n" selected>Nh√¢n vi√™n</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>

                <!-- D√≤ng 2: T√™n ƒëƒÉng nh·∫≠p | M·∫≠t kh·∫©u -->
                <div class="form-group" style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label for="staff-username">T√™n ƒëƒÉng nh·∫≠p *</label>
                        <input type="text" 
                              id="staff-username" 
                              name="username" 
                              class="form-control" 
                              placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" 
                              required>
                    </div>
                    <div style="flex: 1;">
                        <label for="staff-password">M·∫≠t kh·∫©u *</label>
                        <input type="text" 
                              id="staff-password" 
                              name="password" 
                              class="form-control" 
                              placeholder="Nh·∫≠p m·∫≠t kh·∫©u" 
                              required>
                    </div>
                </div>

                <!-- D√≤ng 3: Ng∆∞·ªùi qu·∫£n l√Ω -->
                <div class="form-group" id="manager-field" style="display: none;">
                    <label for="staff-manager">Ng∆∞·ªùi qu·∫£n l√Ω</label>
                    <select id="staff-manager" name="manager" class="form-control">
                        <option value="">Kh√¥ng c√≥ ng∆∞·ªùi qu·∫£n l√Ω</option>
                    </select>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveStaff()">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="status-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="status-modal-title" class="modal-title">Th√™m tr·∫°ng th√°i m·ªõi</h2>
                <button class="close">&times;</button>
            </div>
            <form id="status-form">
                <input type="hidden" id="status-id">
                
                <div class="form-group">
                    <label for="status-name">T√™n tr·∫°ng th√°i *</label>
                    <input type="text" 
                          id="status-name" 
                          name="name" 
                          class="form-control" 
                          placeholder="Nh·∫≠p t√™n tr·∫°ng th√°i" 
                          required>
                </div>

                <div class="form-group">
                    <label for="status-color">M√†u s·∫Øc *</label>
                    <div class="color-input-container">
                        <input type="color" 
                              id="status-color" 
                              name="color" 
                              class="color-picker" 
                              value="#3B82F6" 
                              required>
                        <span class="color-text" id="color-text">#3B82F6</span>
                    </div>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveStatus()">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Order Modal - TH√äM V√ÄO CU·ªêI C√ÅC MODAL KH√ÅC -->
    <div id="add-order-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Th√™m ƒë∆°n h√†ng m·ªõi
                </h2>
                <button class="close">&times;</button>
            </div>
            
            <form id="add-order-form">
                <input type="hidden" id="add-order-customer-id">
                
                <div class="form-group">
                    <label for="add-order-closed-date">Ng√†y ch·ªët <span class="required-star">*</span></label>
                    <input type="date" 
                          id="add-order-closed-date" 
                          name="closedDate" 
                          class="form-control" 
                          required>
                </div>

                <div class="form-group">
                    <label for="add-order-code">M√£ ƒë∆°n h√†ng</label>
                    <input type="text" 
                          id="add-order-code" 
                          name="orderCode" 
                          class="form-control" 
                          placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
                </div>

                <div class="form-group">
                    <label for="add-order-value">Gi√° tr·ªã ƒë∆°n h√†ng <span class="required-star">*</span></label>
                    <input type="text" 
                          id="add-order-value" 
                          name="orderValue" 
                          class="form-control" 
                          placeholder="Nh·∫≠p gi√° tr·ªã ƒë∆°n h√†ng"
                          oninput="formatOrderValue(this)"
                          required>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="cancelAddOrder()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveNewOrder()">
                        <i class="fas fa-save"></i> L∆∞u ƒë∆°n h√†ng
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Order Modal - TH√äM V√ÄO CU·ªêI C√ÅC MODAL KH√ÅC -->
    <div id="edit-order-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-edit"></i> S·ª≠a th√¥ng tin ƒë∆°n h√†ng
                </h2>
                <button class="close">&times;</button>
            </div>
            
            <form id="edit-order-form">
                <input type="hidden" id="edit-order-customer-id">
                <input type="hidden" id="edit-order-created-at">
                
                <div class="form-group">
                    <label for="edit-order-closed-date">Ng√†y ch·ªët <span class="required-star">*</span></label>
                    <input type="date" 
                          id="edit-order-closed-date" 
                          name="closedDate" 
                          class="form-control" 
                          required>
                </div>

                <div class="form-group">
                    <label for="edit-order-code">M√£ ƒë∆°n h√†ng</label>
                    <input type="text" 
                          id="edit-order-code" 
                          name="orderCode" 
                          class="form-control" 
                          placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
                </div>

                <div class="form-group">
                    <label for="edit-order-value">Gi√° tr·ªã ƒë∆°n h√†ng <span class="required-star">*</span></label>
                    <input type="text" 
                          id="edit-order-value" 
                          name="orderValue" 
                          class="form-control" 
                          placeholder="Nh·∫≠p gi√° tr·ªã ƒë∆°n h√†ng"
                          oninput="formatOrderValue(this)"
                          required>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="cancelEditOrder()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveEditOrder()">
                        <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Info Modal -->
    <div id="order-info-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-shopping-cart"></i> Th√¥ng tin ƒë∆°n h√†ng
                </h2>
                <button class="close">&times;</button>
            </div>
            
            <form id="order-info-form">
                <input type="hidden" id="order-customer-id">
                
                <div class="form-group">
                    <label for="order-closed-date">Ng√†y ch·ªët <span class="required-star">*</span></label>
                    <input type="date" 
                          id="order-closed-date" 
                          name="closedDate" 
                          class="form-control" 
                          required>
                </div>

                <div class="form-group">
                    <label for="order-code">M√£ ƒë∆°n h√†ng</label>
                    <input type="text" 
                          id="order-code" 
                          name="orderCode" 
                          class="form-control" 
                          placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
                </div>

                <div class="form-group">
                    <label for="order-value">Gi√° tr·ªã ƒë∆°n h√†ng <span class="required-star">*</span></label>
                    <input type="text" 
                          id="order-value" 
                          name="orderValue" 
                          class="form-control" 
                          placeholder="Nh·∫≠p gi√° tr·ªã ƒë∆°n h√†ng"
                          oninput="formatOrderValue(this)"
                          required>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="cancelOrderInfo()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveOrderInfo()">
                        <i class="fas fa-save"></i> L∆∞u v√† ch·ªët ƒë∆°n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reminder-modal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-edit"></i> Chi ti·∫øt c√¥ng vi·ªác</h2>
                <button class="close">&times;</button>
            </div>
            <form id="reminder-form">
                <input type="hidden" id="remind-id">
                
                <div class="form-group">
                    <label>N·ªôi dung c√¥ng vi·ªác *</label>
                    <textarea id="remind-content" class="form-control" rows="5" required placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
                </div>
                
                <div class="form-group" style="display:flex; gap:15px;">
                    <div style="flex:1">
                        <label>H·∫°n ho√†n th√†nh *</label>
                        <input type="date" id="remind-date" class="form-control" required>
                    </div>
                    <div style="flex:1">
                        <label>M·ª©c ƒë·ªô</label>
                        <select id="remind-priority" class="form-control">
                            <option value="Normal">B√¨nh th∆∞·ªùng</option>
                            <option value="High">G·∫•p</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>G·ª≠i cho ai? *</label>
                    <div class="assign-options">
                        <label><input type="radio" name="assignType" value="all" checked onchange="toggleStaffSelect()"> T·∫•t c·∫£ m·ªçi ng∆∞·ªùi</label>
                        <label><input type="radio" name="assignType" value="specific" onchange="toggleStaffSelect()"> Ch·ªçn ng∆∞·ªùi c·ª• th·ªÉ</label>
                    </div>
                    
                    <div id="staff-checklist-container" style="display:none; border:1px solid #eee; padding:10px; max-height:150px; overflow-y:auto; border-radius:4px; margin-top:5px;">
                        </div>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
                    <button type="button" class="btn btn-success" onclick="saveReminderToSheet()">L∆∞u c√¥ng vi·ªác</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-question-circle"></i> <span id="confirm-title">X√°c nh·∫≠n</span>
                </h2>
            </div>
            
            <div class="modal-body">
                <p id="confirm-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán thao t√°c n√†y?</p>
            </div>
            
            <div class="d-flex gap-3 justify-content-end mt-4">
                <button class="btn btn-secondary" onclick="closeCustomConfirm(false)">
                    H·ªßy
                </button>
                <button class="btn btn-success" onclick="closeCustomConfirm(true)">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u
                </h2>
                <button class="close">&times;</button>
            </div>
            
            <form id="change-password-form">
                <div class="form-group">
                    <label for="new-password">M·∫≠t kh·∫©u m·ªõi <span class="required-star">*</span></label>
                    <input type="password" 
                          id="new-password" 
                          class="form-control" 
                          placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
                          required>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi <span class="required-star">*</span></label>
                    <input type="password" 
                          id="confirm-password" 
                          class="form-control" 
                          placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                          required>
                </div>

                <div class="d-flex gap-3 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        H·ªßy
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveNewPassword()">
                        <i class="fas fa-save"></i> L∆∞u
                    </button>
                </div>
            </form>
        </div>
    </div>

    <?!= include('JavaScript'); ?>
</body>
</html>
